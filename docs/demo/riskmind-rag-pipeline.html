<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RiskMind RAG Pipeline — Deep Dive</title>
<style>
  :root {
    --bg: #0f172a;
    --bg2: #1e293b;
    --bg3: #334155;
    --coral: #ff6b6b;
    --coral2: #ff8787;
    --blue: #60a5fa;
    --cyan: #22d3ee;
    --green: #34d399;
    --amber: #fbbf24;
    --purple: #a78bfa;
    --pink: #f472b6;
    --text: #e2e8f0;
    --text2: #94a3b8;
    --card: #1e293b;
    --border: #334155;
    --radius: 12px;
  }
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
    background: var(--bg);
    color: var(--text);
    line-height: 1.7;
    overflow-x: hidden;
  }

  /* ── Header ── */
  .hero {
    background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 50%, #0f172a 100%);
    padding: 60px 40px;
    text-align: center;
    position: relative;
    overflow: hidden;
  }
  .hero::before {
    content: '';
    position: absolute;
    top: -50%; left: -50%;
    width: 200%; height: 200%;
    background: radial-gradient(circle at 30% 50%, rgba(255,107,107,0.08) 0%, transparent 50%),
                radial-gradient(circle at 70% 50%, rgba(96,165,250,0.08) 0%, transparent 50%);
    animation: pulse 8s ease-in-out infinite;
  }
  @keyframes pulse {
    0%,100% { transform: scale(1); }
    50% { transform: scale(1.05); }
  }
  .hero h1 {
    font-size: 2.8rem;
    font-weight: 800;
    background: linear-gradient(135deg, var(--coral), var(--blue));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    position: relative;
    margin-bottom: 12px;
  }
  .hero p {
    color: var(--text2);
    font-size: 1.15rem;
    position: relative;
  }

  /* ── Container ── */
  .container {
    max-width: 1100px;
    margin: 0 auto;
    padding: 40px 24px;
  }

  /* ── Section ── */
  .section {
    margin-bottom: 48px;
  }
  .section-num {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 38px; height: 38px;
    background: linear-gradient(135deg, var(--coral), #e63946);
    color: #fff;
    font-weight: 800;
    font-size: 1rem;
    border-radius: 50%;
    margin-right: 14px;
    flex-shrink: 0;
  }
  .section h2 {
    display: flex;
    align-items: center;
    font-size: 1.6rem;
    font-weight: 700;
    margin-bottom: 20px;
  }

  /* ── Cards ── */
  .card {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 28px;
    margin-bottom: 20px;
    transition: border-color 0.3s, box-shadow 0.3s;
  }
  .card:hover {
    border-color: var(--coral);
    box-shadow: 0 0 20px rgba(255,107,107,0.1);
  }
  .card h3 {
    font-size: 1.15rem;
    font-weight: 600;
    margin-bottom: 12px;
    color: var(--coral2);
  }

  /* ── Interactive Steps ── */
  .step-flow {
    display: flex;
    flex-direction: column;
    gap: 0;
    position: relative;
  }
  .step {
    display: flex;
    gap: 20px;
    position: relative;
    padding-left: 60px;
    padding-bottom: 32px;
    cursor: pointer;
  }
  .step::before {
    content: '';
    position: absolute;
    left: 18px;
    top: 40px;
    bottom: 0;
    width: 2px;
    background: var(--border);
  }
  .step:last-child::before { display: none; }
  .step-dot {
    position: absolute;
    left: 6px;
    top: 4px;
    width: 26px;
    height: 26px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.75rem;
    color: #fff;
    flex-shrink: 0;
    z-index: 1;
    transition: transform 0.3s, box-shadow 0.3s;
  }
  .step:hover .step-dot {
    transform: scale(1.2);
    box-shadow: 0 0 12px rgba(255,107,107,0.4);
  }
  .step-dot.coral { background: var(--coral); }
  .step-dot.blue { background: var(--blue); }
  .step-dot.green { background: var(--green); }
  .step-dot.purple { background: var(--purple); }
  .step-dot.amber { background: var(--amber); color: #000; }
  .step-dot.cyan { background: var(--cyan); color: #000; }
  .step-dot.pink { background: var(--pink); }
  .step-content {
    flex: 1;
  }
  .step-title {
    font-weight: 700;
    font-size: 1.05rem;
    margin-bottom: 6px;
  }
  .step-detail {
    color: var(--text2);
    font-size: 0.92rem;
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease, opacity 0.3s;
    opacity: 0;
  }
  .step.active .step-detail {
    max-height: 500px;
    opacity: 1;
  }

  /* ── Code blocks ── */
  .code {
    background: #0d1117;
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 16px 20px;
    font-family: 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
    font-size: 0.85rem;
    overflow-x: auto;
    margin: 12px 0;
    line-height: 1.6;
  }
  .kw { color: var(--coral); }
  .str { color: var(--green); }
  .fn { color: var(--blue); }
  .cm { color: #6a737d; }
  .num { color: var(--amber); }
  .op { color: var(--text2); }
  .var { color: var(--cyan); }

  /* ── Diagram ── */
  .diagram {
    background: #0d1117;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 24px;
    font-family: 'Cascadia Code', monospace;
    font-size: 0.82rem;
    overflow-x: auto;
    white-space: pre;
    line-height: 1.5;
    color: var(--text2);
    margin: 16px 0;
  }

  /* ── Vector visual ── */
  .vector-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 16px;
    margin: 16px 0;
  }
  .vector-card {
    background: #0d1117;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 18px;
    transition: border-color 0.3s, transform 0.2s;
  }
  .vector-card:hover {
    border-color: var(--cyan);
    transform: translateY(-2px);
  }
  .vector-card h4 {
    font-size: 0.9rem;
    color: var(--cyan);
    margin-bottom: 8px;
  }
  .vector-nums {
    font-family: monospace;
    font-size: 0.75rem;
    color: var(--amber);
    word-break: break-all;
    margin: 8px 0;
    padding: 8px;
    background: rgba(251,191,36,0.05);
    border-radius: 6px;
  }
  .vector-meta {
    font-size: 0.8rem;
    color: var(--text2);
  }

  /* ── Comparison table ── */
  .comp-table {
    width: 100%;
    border-collapse: collapse;
    margin: 16px 0;
    font-size: 0.9rem;
  }
  .comp-table th {
    background: var(--bg3);
    padding: 10px 16px;
    text-align: left;
    font-weight: 600;
    color: var(--coral2);
    border-bottom: 2px solid var(--coral);
  }
  .comp-table td {
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    color: var(--text2);
  }
  .comp-table tr:hover td {
    background: rgba(255,107,107,0.04);
  }

  /* ── Badges ── */
  .badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 999px;
    font-size: 0.75rem;
    font-weight: 600;
  }
  .badge-coral { background: rgba(255,107,107,0.15); color: var(--coral); }
  .badge-blue { background: rgba(96,165,250,0.15); color: var(--blue); }
  .badge-green { background: rgba(52,211,153,0.15); color: var(--green); }
  .badge-amber { background: rgba(251,191,36,0.15); color: var(--amber); }
  .badge-purple { background: rgba(167,139,250,0.15); color: var(--purple); }
  .badge-cyan { background: rgba(34,211,238,0.15); color: var(--cyan); }

  /* ── Animated pipeline ── */
  .pipeline {
    display: flex;
    align-items: center;
    gap: 4px;
    flex-wrap: wrap;
    margin: 20px 0;
    justify-content: center;
  }
  .pipe-node {
    padding: 10px 18px;
    border-radius: 8px;
    font-size: 0.82rem;
    font-weight: 600;
    text-align: center;
    min-width: 100px;
    animation: fadeUp 0.5s ease forwards;
    opacity: 0;
  }
  .pipe-node:nth-child(1) { animation-delay: 0.1s; }
  .pipe-node:nth-child(2) { animation-delay: 0.3s; }
  .pipe-node:nth-child(3) { animation-delay: 0.5s; }
  .pipe-node:nth-child(4) { animation-delay: 0.7s; }
  .pipe-node:nth-child(5) { animation-delay: 0.9s; }
  .pipe-node:nth-child(6) { animation-delay: 1.1s; }
  .pipe-node:nth-child(7) { animation-delay: 1.3s; }
  .pipe-node:nth-child(8) { animation-delay: 1.5s; }
  .pipe-node:nth-child(9) { animation-delay: 1.7s; }
  .pipe-node:nth-child(10) { animation-delay: 1.9s; }
  .pipe-node:nth-child(11) { animation-delay: 2.1s; }
  @keyframes fadeUp {
    from { opacity:0; transform: translateY(10px); }
    to { opacity:1; transform: translateY(0); }
  }
  .pipe-arrow {
    color: var(--text2);
    font-size: 1.1rem;
    animation: fadeUp 0.5s ease forwards;
    opacity: 0;
  }
  .pipe-arrow:nth-child(2) { animation-delay: 0.2s; }
  .pipe-arrow:nth-child(4) { animation-delay: 0.4s; }
  .pipe-arrow:nth-child(6) { animation-delay: 0.6s; }
  .pipe-arrow:nth-child(8) { animation-delay: 0.8s; }
  .pipe-arrow:nth-child(10) { animation-delay: 1.0s; }
  .n-coral { background: rgba(255,107,107,0.15); color: var(--coral); border: 1px solid rgba(255,107,107,0.3); }
  .n-blue { background: rgba(96,165,250,0.15); color: var(--blue); border: 1px solid rgba(96,165,250,0.3); }
  .n-green { background: rgba(52,211,153,0.15); color: var(--green); border: 1px solid rgba(52,211,153,0.3); }
  .n-amber { background: rgba(251,191,36,0.15); color: var(--amber); border: 1px solid rgba(251,191,36,0.3); }
  .n-purple { background: rgba(167,139,250,0.15); color: var(--purple); border: 1px solid rgba(167,139,250,0.3); }
  .n-cyan { background: rgba(34,211,238,0.15); color: var(--cyan); border: 1px solid rgba(34,211,238,0.3); }
  .n-pink { background: rgba(244,114,182,0.15); color: var(--pink); border: 1px solid rgba(244,114,182,0.3); }

  /* ── Expandable ── */
  .expand-btn {
    background: none;
    border: 1px solid var(--border);
    color: var(--coral);
    padding: 6px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85rem;
    margin-top: 10px;
    transition: all 0.2s;
  }
  .expand-btn:hover {
    background: rgba(255,107,107,0.1);
    border-color: var(--coral);
  }
  .expandable {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.5s ease;
  }
  .expandable.open {
    max-height: 2000px;
  }

  /* ── Similarity visual ── */
  .sim-bar {
    height: 8px;
    border-radius: 4px;
    background: var(--bg3);
    margin: 6px 0;
    overflow: hidden;
  }
  .sim-fill {
    height: 100%;
    border-radius: 4px;
    transition: width 1s ease;
  }
  .sim-fill.high { background: var(--green); }
  .sim-fill.med { background: var(--amber); }
  .sim-fill.low { background: var(--coral); }
  .sim-label {
    display: flex;
    justify-content: space-between;
    font-size: 0.8rem;
    color: var(--text2);
  }

  /* ── Tab system ── */
  .tabs {
    display: flex;
    gap: 4px;
    margin-bottom: 0;
    border-bottom: 2px solid var(--border);
    padding-bottom: 0;
  }
  .tab-btn {
    background: none;
    border: none;
    color: var(--text2);
    padding: 10px 20px;
    cursor: pointer;
    font-size: 0.9rem;
    font-weight: 600;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  .tab-btn.active {
    color: var(--coral);
    border-bottom-color: var(--coral);
  }
  .tab-btn:hover { color: var(--text); }
  .tab-content {
    display: none;
    padding: 20px 0;
  }
  .tab-content.active { display: block; }

  /* ── Footer ── */
  .footer {
    text-align: center;
    padding: 40px;
    color: var(--text2);
    font-size: 0.85rem;
    border-top: 1px solid var(--border);
    margin-top: 40px;
  }

  /* ── Highlight ── */
  .highlight {
    background: rgba(255,107,107,0.08);
    border-left: 3px solid var(--coral);
    padding: 16px 20px;
    border-radius: 0 8px 8px 0;
    margin: 16px 0;
    font-size: 0.92rem;
  }

  /* ── Live data counter ── */
  .live-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 12px;
    margin: 20px 0;
  }
  .stat-card {
    background: var(--bg3);
    padding: 16px;
    border-radius: 10px;
    text-align: center;
  }
  .stat-num {
    font-size: 1.8rem;
    font-weight: 800;
    margin-bottom: 4px;
  }
  .stat-label {
    font-size: 0.8rem;
    color: var(--text2);
  }

  @media (max-width: 768px) {
    .hero h1 { font-size: 1.8rem; }
    .pipeline { flex-direction: column; }
    .pipe-arrow { transform: rotate(90deg); }
  }
</style>
</head>
<body>

<!-- ════════════════ HERO ════════════════ -->
<div class="hero">
  <h1>RiskMind RAG Pipeline</h1>
  <p>How documents are uploaded, embedded, stored in ChromaDB, and retrieved for AI reasoning</p>
</div>

<div class="container">

<!-- ════════════════ OVERVIEW ════════════════ -->
<div class="section">
  <h2><span class="section-num">0</span> The Big Picture</h2>

  <div class="card">
    <h3>What is RAG?</h3>
    <p><strong>Retrieval-Augmented Generation</strong> means the AI doesn't just rely on its training data. Before answering, it <em>retrieves</em> relevant documents from your private data (ChromaDB vector store) and <em>augments</em> the prompt with that context. This gives the LLM access to your specific insurance guidelines, claim histories, and uploaded documents.</p>

    <div class="highlight" style="margin-top:16px">
      <strong>Without RAG:</strong> LLM only knows generic insurance knowledge<br>
      <strong>With RAG:</strong> LLM sees YOUR guidelines + YOUR claims + YOUR uploaded documents = accurate, grounded answers
    </div>
  </div>

  <div class="card">
    <h3>End-to-End Pipeline (click each node)</h3>
    <div class="pipeline">
      <div class="pipe-node n-coral">User Uploads PDF</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-blue">Bedrock Claude Analyzes</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-green">Text Extracted</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-cyan">Embedding Model</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-purple">ChromaDB Stores Vector</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-amber">User Asks Question</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-cyan">Query Embedded</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-purple">Similarity Search</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-green">Top K Retrieved</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-blue">LLM + Context</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-coral">Grounded Answer</div>
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 1: UPLOAD ════════════════ -->
<div class="section">
  <h2><span class="section-num">1</span> Document Upload</h2>

  <div class="card">
    <h3>How Files Enter the System</h3>
    <p>When a user clicks the paperclip icon in the RiskMind chat and selects a file, here's what happens:</p>

    <div class="step-flow">
      <div class="step active" onclick="toggleStep(this)">
        <div class="step-dot coral">1</div>
        <div class="step-content">
          <div class="step-title">Frontend sends file to API</div>
          <div class="step-detail">
            <div class="code">
<span class="cm">// Frontend: api.ts</span>
<span class="kw">const</span> formData = <span class="kw">new</span> <span class="fn">FormData</span>()
formData.<span class="fn">append</span>(<span class="str">'file'</span>, selectedFile)
formData.<span class="fn">append</span>(<span class="str">'user_prompt'</span>, <span class="str">'Analyze for underwriting risks'</span>)

<span class="cm">// POST /api/chat/upload</span>
<span class="kw">const</span> response = <span class="kw">await</span> axios.<span class="fn">post</span>(<span class="str">'/api/chat/upload'</span>, formData)
            </div>
            <p>The file is sent as multipart form data. Supported types: <span class="badge badge-blue">PDF</span> <span class="badge badge-green">PNG</span> <span class="badge badge-green">JPG</span> <span class="badge badge-amber">MP4</span></p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot blue">2</div>
        <div class="step-content">
          <div class="step-title">Backend validates and saves file</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># Backend: chat.py - /api/chat/upload endpoint</span>
<span class="var">file_ext</span> = os.path.<span class="fn">splitext</span>(file.filename)[<span class="num">1</span>]
<span class="var">unique_name</span> = <span class="str">f"</span>{uuid4()}{file_ext}<span class="str">"</span>
<span class="var">file_path</span> = os.path.<span class="fn">join</span>(UPLOAD_DIR, unique_name)

<span class="cm"># Save to: backend/data/uploads/a1b2c3d4.pdf</span>
<span class="kw">with</span> <span class="fn">open</span>(file_path, <span class="str">"wb"</span>) <span class="kw">as</span> f:
    f.<span class="fn">write</span>(<span class="kw">await</span> file.<span class="fn">read</span>())
            </div>
            <p>Each file gets a UUID filename to prevent collisions. Files are stored on the persistent disk at <code>/app/data/uploads/</code></p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot green">3</div>
        <div class="step-content">
          <div class="step-title">AI analyzes the document</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># Fallback chain for analysis:</span>
<span class="cm"># PDFs:   Bedrock Claude (native PDF) -> Gemini -> OpenAI</span>
<span class="cm"># Images: Bedrock Claude Vision -> Gemini Vision -> OpenAI GPT-4o</span>

<span class="cm"># For PDFs - Bedrock sends the raw PDF bytes directly</span>
<span class="var">response</span> = bedrock_client.<span class="fn">converse</span>(
    modelId=<span class="str">"us.anthropic.claude-sonnet-4-20250514"</span>,
    messages=[{
        <span class="str">"role"</span>: <span class="str">"user"</span>,
        <span class="str">"content"</span>: [
            {<span class="str">"text"</span>: <span class="str">"Analyze this insurance document..."</span>},
            {<span class="str">"document"</span>: {<span class="str">"format"</span>: <span class="str">"pdf"</span>, <span class="str">"source"</span>: {<span class="str">"bytes"</span>: pdf_bytes}}}
        ]
    }]
)
<span class="var">analysis_summary</span> = response[<span class="str">"output"</span>][<span class="str">"message"</span>][<span class="str">"content"</span>][<span class="num">0</span>][<span class="str">"text"</span>]
            </div>
            <p>Claude reads the actual PDF (not just extracted text) and produces a structured analysis: key findings, risks, relevant data points, and underwriting implications.</p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot purple">4</div>
        <div class="step-content">
          <div class="step-title">Document record saved to SQLite</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># Save metadata to 'documents' table</span>
<span class="var">doc</span> = Document(
    filename     = <span class="str">"property-inspection.pdf"</span>,
    file_path    = <span class="str">"/app/data/uploads/a1b2c3d4.pdf"</span>,
    file_type    = <span class="str">"pdf"</span>,
    file_size    = <span class="num">245000</span>,  <span class="cm"># bytes</span>
    uploaded_by  = <span class="str">"demo_user"</span>,
    analysis_summary = <span class="str">"This property inspection report reveals..."</span>,
    policy_number = <span class="kw">None</span>,  <span class="cm"># NULL for chat uploads</span>
    claim_number  = <span class="kw">None</span>,  <span class="cm"># Set when uploaded via claim evidence</span>
    session_id    = <span class="num">42</span>,    <span class="cm"># Links to current chat session</span>
)
db.<span class="fn">add</span>(doc)
<span class="kw">await</span> db.<span class="fn">commit</span>()
            </div>
            <table class="comp-table" style="margin-top:12px">
              <tr><th>Column</th><th>Purpose</th></tr>
              <tr><td>filename</td><td>Original name for display</td></tr>
              <tr><td>file_path</td><td>Absolute path to saved file</td></tr>
              <tr><td>analysis_summary</td><td>AI-generated analysis text</td></tr>
              <tr><td>policy_number</td><td>Links to a specific policy (if attached)</td></tr>
              <tr><td>claim_number</td><td>Links to a specific claim (if evidence upload)</td></tr>
              <tr><td>session_id</td><td>Links to the chat session where it was uploaded</td></tr>
            </table>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot cyan">5</div>
        <div class="step-content">
          <div class="step-title">Analysis indexed into ChromaDB (this is the RAG part!)</div>
          <div class="step-detail">
            <p>This is where the magic happens. The analysis text gets converted into a <strong>vector embedding</strong> and stored in ChromaDB for future retrieval.</p>
            <div class="code">
<span class="cm"># vector_store.py - index_document()</span>
<span class="var">text</span> = <span class="str">f"Uploaded pdf document: {filename}. "</span>
       <span class="str">f"[Policy: {policy_number}]. "</span>
       <span class="str">f"[Claim: {claim_number}]. "</span>
       <span class="str">f"AI Analysis: {analysis[:2000]}"</span>

<span class="var">knowledge_collection</span>.<span class="fn">upsert</span>(
    ids       = [<span class="str">f"document_{doc_id}"</span>],
    documents = [text],             <span class="cm"># ChromaDB auto-embeds this</span>
    metadatas = [{
        <span class="str">"type"</span>: <span class="str">"document"</span>,
        <span class="str">"filename"</span>: filename,
        <span class="str">"file_type"</span>: <span class="str">"pdf"</span>,
        <span class="str">"policy_number"</span>: <span class="str">""</span>,
        <span class="str">"claim_number"</span>: <span class="str">""</span>,
    }]
)
            </div>
            <p>ChromaDB takes the text, runs it through an <strong>embedding model</strong> (a neural network that converts text to numbers), and stores the resulting vector alongside the metadata. More on this in the next section.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 2: EMBEDDINGS ════════════════ -->
<div class="section">
  <h2><span class="section-num">2</span> Vector Embeddings — How Text Becomes Numbers</h2>

  <div class="card">
    <h3>What is an Embedding?</h3>
    <p>An embedding is a list of numbers (a "vector") that captures the <em>meaning</em> of text. Similar meanings produce similar numbers, even if the exact words are different.</p>

    <div class="highlight">
      <strong>Key Insight:</strong> "The building has fire damage" and "property sustained fire loss" have completely different words but nearly identical embeddings, because their <em>meaning</em> is the same. This is why vector search works better than keyword search.
    </div>

    <h3 style="margin-top:20px">How It Works Inside ChromaDB</h3>

    <div class="tabs">
      <button class="tab-btn active" onclick="switchTab(event, 'tab-embed')">Embedding Process</button>
      <button class="tab-btn" onclick="switchTab(event, 'tab-visual')">Visual Example</button>
      <button class="tab-btn" onclick="switchTab(event, 'tab-providers')">Embedding Providers</button>
    </div>

    <div id="tab-embed" class="tab-content active">
      <div class="diagram">  Input Text                          Output Vector (1536 dimensions)
  =====================               ================================

  "Property inspection             [0.0234, -0.0891, 0.1456, 0.0023,
   reveals roof damage              -0.0567, 0.0912, -0.0345, 0.0789,
   and water intrusion              0.1234, -0.0456, ... (1536 total)
   in the west wing"                0.0678, -0.0123, 0.0456, 0.0891]

         |                                    |
         v                                    v
  Embedding Model                    These numbers encode:
  (Neural Network)                   - "property" concept
                                     - "damage" concept
                                     - "water" concept
                                     - "building structure" concept
                                     - Relationships between all words</div>
      <p>Each dimension captures a different aspect of meaning. Dimension 47 might roughly correspond to "property-related", dimension 892 to "damage severity", etc. The model learns these automatically during training.</p>
    </div>

    <div id="tab-visual" class="tab-content">
      <p>Here's how different documents look as vectors (simplified to 2D for visualization):</p>
      <div class="diagram" style="text-align:center; color: var(--text);">
                            MEANING SPACE (simplified 2D)

       Property Risk ^
                     |
                     |   [Doc: Fire inspection]  *
                     |                          * [Doc: Smoke damage claim]
                     |
                     |          * [Doc: Property valuation]
                     |
                     |
                     |  * [Doc: Water damage report]
                     |
          -----------|------------------------------------>
                     |                        Financial Risk
                     |
                     |          * [Guideline: Premium calc]
                     |
                     |                  * [Guideline: Loss ratio thresholds]
                     |

       When user asks "What risks did the fire inspection find?"
       The query vector lands NEAR the fire inspection document.
       ChromaDB returns the closest matches by distance.</div>
    </div>

    <div id="tab-providers" class="tab-content">
      <p>RiskMind uses a priority chain for embeddings:</p>
      <table class="comp-table">
        <tr><th>Priority</th><th>Provider</th><th>Model</th><th>Dimensions</th></tr>
        <tr><td><span class="badge badge-coral">1st</span></td><td>AWS Bedrock</td><td>Amazon Titan Embed</td><td>1536</td></tr>
        <tr><td><span class="badge badge-blue">2nd</span></td><td>OpenAI</td><td>text-embedding-3-small</td><td>1536</td></tr>
        <tr><td><span class="badge badge-green">3rd</span></td><td>ChromaDB Default</td><td>all-MiniLM-L6-v2</td><td>384</td></tr>
      </table>
      <div class="code">
<span class="cm"># vector_store.py - _make_ef()</span>
<span class="kw">def</span> <span class="fn">_make_ef</span>():
    <span class="cm"># Try Bedrock Titan first</span>
    <span class="kw">if</span> AWS_KEY:
        <span class="kw">return</span> AmazonBedrockEmbeddingFunction(...)
    <span class="cm"># Fall back to OpenAI</span>
    <span class="kw">if</span> OPENAI_KEY:
        <span class="kw">return</span> OpenAIEmbeddingFunction(model=<span class="str">"text-embedding-3-small"</span>)
    <span class="cm"># Default: ChromaDB's built-in model (runs locally, free)</span>
    <span class="kw">return</span> <span class="kw">None</span>  <span class="cm"># ChromaDB uses all-MiniLM-L6-v2</span>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 3: CHROMADB STORAGE ════════════════ -->
<div class="section">
  <h2><span class="section-num">3</span> ChromaDB — The Vector Database</h2>

  <div class="card">
    <h3>What's Inside ChromaDB</h3>
    <p>ChromaDB stores data in <strong>collections</strong> (like tables in SQL). RiskMind has two collections:</p>

    <div class="live-stats">
      <div class="stat-card">
        <div class="stat-num" style="color:var(--coral)">guidelines</div>
        <div class="stat-label">Underwriting rules, thresholds, section codes</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" style="color:var(--cyan)">knowledge</div>
        <div class="stat-label">Claims + Decisions + Uploaded Documents</div>
      </div>
    </div>

    <h3 style="margin-top:24px">What Each Record Looks Like</h3>
    <div class="vector-grid">
      <div class="vector-card">
        <h4>Guideline Record</h4>
        <p style="font-size:0.85rem; color:var(--text)">ID: <code>guideline_5</code></p>
        <p style="font-size:0.85rem; color:var(--text2); margin:6px 0">Text: "Section 5.1.1 - Loss ratio below 50% qualifies for 3% premium discount..."</p>
        <div class="vector-nums">[0.0234, -0.0891, 0.1456, 0.0023, -0.0567, 0.0912, ...] (1536 dims)</div>
        <div class="vector-meta">
          metadata: {section_code: "5.1.1", category: "pricing", type: "guideline"}
        </div>
      </div>

      <div class="vector-card">
        <h4>Claim Record</h4>
        <p style="font-size:0.85rem; color:var(--text)">ID: <code>claim_12</code></p>
        <p style="font-size:0.85rem; color:var(--text2); margin:6px 0">Text: "Claim CLM-2024-012: Water damage from burst pipe. Amount: $45,000. Status: Approved."</p>
        <div class="vector-nums">[0.0891, -0.0234, 0.0567, 0.1234, -0.0789, 0.0456, ...] (1536 dims)</div>
        <div class="vector-meta">
          metadata: {type: "claim", claim_number: "CLM-2024-012", policy_id: 3}
        </div>
      </div>

      <div class="vector-card">
        <h4>Uploaded Document Record</h4>
        <p style="font-size:0.85rem; color:var(--text)">ID: <code>document_7</code></p>
        <p style="font-size:0.85rem; color:var(--text2); margin:6px 0">Text: "Uploaded pdf: inspection-report.pdf. AI Analysis: Property shows signs of structural weakness in north wall..."</p>
        <div class="vector-nums">[0.1456, -0.0567, 0.0912, 0.0345, -0.0891, 0.0234, ...] (1536 dims)</div>
        <div class="vector-meta">
          metadata: {type: "document", filename: "inspection-report.pdf", policy_number: "POL-001"}
        </div>
      </div>

      <div class="vector-card">
        <h4>Decision Record</h4>
        <p style="font-size:0.85rem; color:var(--text)">ID: <code>decision_4</code></p>
        <p style="font-size:0.85rem; color:var(--text2); margin:6px 0">Text: "Policy POL-005 decision: DECLINE. Reason: Loss ratio 120%, 7 claims in 2 years."</p>
        <div class="vector-nums">[0.0345, -0.1234, 0.0789, 0.0567, -0.0456, 0.0912, ...] (1536 dims)</div>
        <div class="vector-meta">
          metadata: {type: "decision", policy_number: "POL-005", decision: "decline"}
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>ChromaDB Storage on Disk</h3>
    <div class="diagram">  /app/data/chroma_db/                    <span style="color:var(--coral)">&larr; Persistent disk (survives redeploys)</span>
  ├── chroma.sqlite3                      <span style="color:var(--text2)"># Metadata + IDs + text</span>
  └── collections/
      ├── guidelines/                     <span style="color:var(--amber)"># 15 underwriting rules</span>
      │   ├── data_level0.bin             <span style="color:var(--text2)"># HNSW index (vector search)</span>
      │   └── header.bin
      └── knowledge/                      <span style="color:var(--cyan)"># Claims + Decisions + Documents</span>
          ├── data_level0.bin             <span style="color:var(--text2)"># HNSW index</span>
          └── header.bin

  <span style="color:var(--green)">HNSW = Hierarchical Navigable Small World graph</span>
  <span style="color:var(--text2)">An algorithm that finds nearest neighbors in high-dimensional space</span>
  <span style="color:var(--text2)">in O(log n) time instead of comparing every vector (O(n)).</span></div>
  </div>
</div>

<!-- ════════════════ PHASE 4: RETRIEVAL ════════════════ -->
<div class="section">
  <h2><span class="section-num">4</span> RAG Retrieval — When the User Asks a Question</h2>

  <div class="card">
    <h3>The Full Retrieval Pipeline</h3>
    <p>When the user sends a message like <em>"What risks were found in the property inspection?"</em>, here's every step:</p>

    <div class="step-flow">
      <div class="step active" onclick="toggleStep(this)">
        <div class="step-dot coral">1</div>
        <div class="step-content">
          <div class="step-title">User message enters the LangGraph agent pipeline</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># agent_graph.py - 8-node state machine</span>
<span class="cm"># Node 1: Intent Classification</span>
<span class="cm"># Node 2: Entity Extraction</span>
<span class="cm"># Node 3: Data Retrieval</span>
<span class="cm"># Node 4: RAG Retrieval &larr; THIS IS WHERE IT HAPPENS</span>
<span class="cm"># Node 5: Confidence Scoring</span>
<span class="cm"># Node 6: Response Generation</span>
<span class="cm"># Node 7: Output Formatting</span>
<span class="cm"># Node 8: Session Persistence</span>
            </div>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot blue">2</div>
        <div class="step-content">
          <div class="step-title">Query is embedded using the same embedding model</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># The user's question gets converted to a vector</span>
<span class="var">query</span> = <span class="str">"What risks were found in the property inspection?"</span>

<span class="cm"># Same embedding model used for storage!</span>
<span class="cm"># This is critical - query and documents must use same model</span>
<span class="var">query_vector</span> = embedding_model.<span class="fn">embed</span>(query)
<span class="cm"># Result: [0.1389, -0.0672, 0.0845, ...] (1536 dims)</span>
            </div>
            <p><strong>Critical:</strong> The query MUST use the same embedding model as the stored documents. If you stored with Titan and search with MiniLM, the vectors won't be compatible and results will be garbage.</p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot green">3</div>
        <div class="step-content">
          <div class="step-title">ChromaDB performs cosine similarity search</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># vector_store.py - search_guidelines() and search_knowledge()</span>

<span class="cm"># Search guidelines collection (k=5 nearest)</span>
<span class="var">guideline_results</span> = guidelines_collection.<span class="fn">query</span>(
    query_texts = [<span class="str">"What risks were found in the property inspection?"</span>],
    n_results   = <span class="num">5</span>,
)

<span class="cm"># Search knowledge collection (k=4 nearest)</span>
<span class="var">knowledge_results</span> = knowledge_collection.<span class="fn">query</span>(
    query_texts = [<span class="str">"What risks were found in the property inspection?"</span>],
    n_results   = <span class="num">4</span>,
)
            </div>

            <p style="margin-top:12px"><strong>Cosine Similarity</strong> measures the angle between two vectors. Smaller angle = more similar meaning:</p>

            <div style="margin-top:12px">
              <div class="sim-label"><span>Document: "Property inspection reveals roof damage"</span><span style="color:var(--green)">0.94</span></div>
              <div class="sim-bar"><div class="sim-fill high" style="width:94%"></div></div>

              <div class="sim-label"><span>Document: "Water damage claim for burst pipe"</span><span style="color:var(--amber)">0.71</span></div>
              <div class="sim-bar"><div class="sim-fill med" style="width:71%"></div></div>

              <div class="sim-label"><span>Guideline: "Section 3.1 - High risk thresholds"</span><span style="color:var(--amber)">0.65</span></div>
              <div class="sim-bar"><div class="sim-fill med" style="width:65%"></div></div>

              <div class="sim-label"><span>Decision: "POL-005 declined for high loss ratio"</span><span style="color:var(--coral)">0.38</span></div>
              <div class="sim-bar"><div class="sim-fill low" style="width:38%"></div></div>
            </div>
            <p style="margin-top:8px; color:var(--text2); font-size:0.85rem">ChromaDB returns the top K results sorted by similarity score. The property inspection document scores highest because its meaning is closest to the query.</p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot amber">4</div>
        <div class="step-content">
          <div class="step-title">Session documents also retrieved from SQLite</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># chat.py - Fetch recent uploads from current session</span>
<span class="var">session_docs</span> = <span class="kw">await</span> db.<span class="fn">execute</span>(text(<span class="str">"""
    SELECT filename, file_type, analysis_summary,
           policy_number, claim_number
    FROM documents
    WHERE session_id = :sid
    AND analysis_summary IS NOT NULL
    ORDER BY created_at DESC LIMIT 5
"""</span>), {<span class="str">"sid"</span>: current_session_id})
            </div>
            <p>This is a <strong>direct SQL lookup</strong>, not a vector search. It ensures the LLM always sees documents uploaded in the current conversation, regardless of semantic similarity.</p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot purple">5</div>
        <div class="step-content">
          <div class="step-title">All context assembled into the LLM prompt</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># The final prompt sent to Claude / Gemini looks like this:</span>

<span class="str">"""
SYSTEM: You are RiskMind, an AI underwriting co-pilot...

STRUCTURED DATA SNAPSHOT:
- 21 active policies, total premium: $2.4M
- 55 claims, total exposure: $1.8M
- Portfolio loss ratio: 75%

UPLOADED DOCUMENTS IN THIS SESSION:
1. inspection-report.pdf (pdf)
   Analysis: "Property shows signs of structural weakness
   in north wall. Roof has 3 areas of water damage..."

UNDERWRITING GUIDELINES (from ChromaDB):
- Section 3.1: Properties with 5+ claims = HIGH risk
- Section 5.1.3: Loss ratio > 65% = 15-25% surcharge

KNOWLEDGE BASE (from ChromaDB):
- Claim CLM-2024-012: Water damage, $45,000
- Document: inspection-report.pdf analysis shows roof damage

USER QUESTION: What risks were found in the property inspection?
"""</span>
            </div>
            <p>The LLM now has <strong>four sources of context</strong>: structured data (SQL), session documents (direct), guidelines (ChromaDB RAG), and knowledge (ChromaDB RAG). This is the "augmented" part of RAG.</p>
          </div>
        </div>
      </div>

      <div class="step" onclick="toggleStep(this)">
        <div class="step-dot cyan">6</div>
        <div class="step-content">
          <div class="step-title">LLM generates a grounded response</div>
          <div class="step-detail">
            <div class="code">
<span class="cm"># The LLM responds with specific references to the retrieved context:</span>

<span class="str">"Based on the uploaded property inspection report, the key risks
identified are:

1. **Structural Weakness** - North wall shows signs of degradation
2. **Water Damage** - 3 areas of roof damage with active leaks
3. **Historical Claims** - This property has CLM-2024-012 ($45,000
   water damage), consistent with the inspection findings

Per Guideline 5.1.3, the current loss ratio of 75% warrants a
15-25% premium surcharge. Recommendation: REFER for senior
underwriter review before renewal."</span>
            </div>
            <p>The response cites specific documents, claims, and guidelines. This is the <strong>"Glass Box"</strong> approach — every AI statement is traceable back to evidence.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 5: THREE COLLECTIONS DEEP DIVE ════════════════ -->
<div class="section">
  <h2><span class="section-num">5</span> What's Stored in Each ChromaDB Collection</h2>

  <div class="card">
    <h3>Collection: <code>guidelines</code></h3>
    <p>Indexed at startup from the <code>guidelines</code> SQLite table. Contains underwriting rules.</p>
    <table class="comp-table">
      <tr><th>Field</th><th>Example</th><th>Purpose</th></tr>
      <tr><td>ID</td><td><code>guideline_5</code></td><td>Unique identifier</td></tr>
      <tr><td>Document Text</td><td>"Section 5.1.1: Loss ratio below 50% qualifies for 3% premium discount. Apply to clean accounts only."</td><td>Searchable text</td></tr>
      <tr><td>Embedding</td><td>[0.023, -0.089, ...] (1536 dims)</td><td>Vector for similarity search</td></tr>
      <tr><td>Metadata</td><td>{section_code: "5.1.1", category: "pricing", title: "Premium Discount"}</td><td>Filtering & display</td></tr>
    </table>
    <div class="code" style="margin-top:12px">
<span class="cm"># vector_store.py - index_guidelines()</span>
<span class="kw">for</span> g <span class="kw">in</span> all_guidelines:
    text = <span class="str">f"Guideline {g.section_code}: {g.title}. {g.content}"</span>
    collection.<span class="fn">upsert</span>(
        ids=[<span class="str">f"guideline_{g.id}"</span>],
        documents=[text],
        metadatas=[{<span class="str">"section_code"</span>: g.section_code, <span class="str">"category"</span>: g.category}]
    )
    </div>
  </div>

  <div class="card">
    <h3>Collection: <code>knowledge</code></h3>
    <p>Contains three types of records, distinguished by <code>metadata.type</code>:</p>

    <div class="live-stats">
      <div class="stat-card">
        <div class="stat-num" style="color:var(--blue); font-size:1.2rem">type: "claim"</div>
        <div class="stat-label">55+ claim narratives with amounts and status</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" style="color:var(--green); font-size:1.2rem">type: "decision"</div>
        <div class="stat-label">Underwriting decisions with reasons</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" style="color:var(--purple); font-size:1.2rem">type: "document"</div>
        <div class="stat-label">Uploaded file analyses</div>
      </div>
    </div>

    <div class="code">
<span class="cm"># All three types live in the SAME collection</span>
<span class="cm"># This means a single search can find relevant claims,</span>
<span class="cm"># decisions, AND documents simultaneously</span>

knowledge.<span class="fn">query</span>(
    query_texts=[<span class="str">"fire damage risk"</span>],
    n_results=<span class="num">4</span>
)
<span class="cm"># Might return:</span>
<span class="cm"># 1. claim_15   - "Fire damage claim, $89,000" (sim: 0.91)</span>
<span class="cm"># 2. document_7 - "Fire inspection report analysis" (sim: 0.87)</span>
<span class="cm"># 3. decision_3 - "POL-003 declined due to fire history" (sim: 0.72)</span>
<span class="cm"># 4. claim_22   - "Smoke damage from adjacent property" (sim: 0.68)</span>
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 6: DATA FLOW DIAGRAM ════════════════ -->
<div class="section">
  <h2><span class="section-num">6</span> Complete Data Flow Diagram</h2>

  <div class="card" style="padding: 12px;">
    <div class="diagram" style="font-size:0.78rem; line-height:1.4">
<span style="color:var(--coral); font-weight:700">UPLOAD PHASE (happens once per document)</span>

  User clicks paperclip
       |
       v
  +-----------------+     +------------------+     +------------------+
  | Frontend        | --> | POST /api/chat/  | --> | Save file to     |
  | (React)         |     | upload           |     | /data/uploads/   |
  +-----------------+     +------------------+     +------------------+
                                                          |
                                                          v
                          +------------------+     +------------------+
                          | Return analysis  | <-- | Bedrock Claude   |
                          | to chat UI       |     | analyzes PDF/img |
                          +------------------+     +------------------+
                                                          |
                                  +-------------------+---+-------------------+
                                  |                   |                       |
                                  v                   v                       v
                          +-------------+     +---------------+     +------------------+
                          | SQLite      |     | ChromaDB      |     | File System      |
                          | documents   |     | knowledge     |     | /data/uploads/   |
                          | table       |     | collection    |     | {uuid}.pdf       |
                          +-------------+     +---------------+     +------------------+
                          | filename    |     | ID: doc_7     |
                          | file_path   |     | text: "..."   |
                          | analysis    |     | vector: [...]  |
                          | session_id  |     | meta: {type}  |
                          +-------------+     +---------------+


<span style="color:var(--cyan); font-weight:700">RETRIEVAL PHASE (happens every chat message)</span>

  User asks question
       |
       v
  +-----------------+     +------------------+
  | LangGraph       | --> | Node 4: RAG      |
  | Agent Pipeline  |     | Retrieval        |
  +-----------------+     +------------------+
                                  |
                  +---------------+---------------+
                  |               |               |
                  v               v               v
          +---------------+ +-----------+ +---------------+
          | ChromaDB      | | ChromaDB  | | SQLite        |
          | guidelines    | | knowledge | | session_docs  |
          | (k=5)         | | (k=4)     | | (limit 5)     |
          +---------------+ +-----------+ +---------------+
          | Pricing rules | | Claims    | | This session's|
          | Risk thresh.  | | Decisions | | uploaded docs |
          | Procedures    | | Documents | | with analyses |
          +---------------+ +-----------+ +---------------+
                  |               |               |
                  +---------------+---------------+
                                  |
                                  v
                          +------------------+
                          | Assemble Prompt  |
                          | Data Snapshot    |
                          | + Guidelines     |
                          | + Knowledge      |
                          | + Session Docs   |
                          +------------------+
                                  |
                                  v
                          +------------------+
                          | LLM (Claude /    |
                          | Gemini / OpenAI) |
                          +------------------+
                                  |
                                  v
                          +------------------+
                          | Grounded answer  |
                          | citing evidence  |
                          +------------------+</div>
  </div>
</div>

<!-- ════════════════ PHASE 7: CLAIM EVIDENCE ════════════════ -->
<div class="section">
  <h2><span class="section-num">7</span> Claim Evidence Upload (Linked Documents)</h2>

  <div class="card">
    <h3>How Evidence Attaches to Claims</h3>
    <p>When evidence is uploaded via the claim-specific endpoint, it creates a stronger link:</p>

    <div class="code">
<span class="cm"># POST /api/claims/{claim_id}/evidence/upload</span>

<span class="cm"># 1. File saved to claim-specific directory</span>
<span class="var">path</span> = <span class="str">f"data/uploads/claims/{claim_number}/{uuid}.pdf"</span>

<span class="cm"># 2. Appended to claim's evidence_files JSON</span>
<span class="var">evidence_files</span> = [
    {
        <span class="str">"type"</span>: <span class="str">"pdf"</span>,
        <span class="str">"url"</span>: <span class="str">"/api/uploads/claims/CLM-2024-012/a1b2c3.pdf"</span>,
        <span class="str">"local_path"</span>: <span class="str">"data/uploads/claims/CLM-2024-012/a1b2c3.pdf"</span>,
        <span class="str">"description"</span>: <span class="str">"Fire damage inspection report"</span>
    }
]

<span class="cm"># 3. Document record created WITH policy + claim links</span>
<span class="var">doc</span> = Document(
    policy_number = <span class="str">"POL-001"</span>,  <span class="cm">&larr; resolved from claim.policy_id</span>
    claim_number  = <span class="str">"CLM-2024-012"</span>,
    analysis_summary = <span class="str">"Fire damage report showing..."</span>
)

<span class="cm"># 4. Indexed in ChromaDB with policy/claim metadata</span>
knowledge.<span class="fn">upsert</span>(
    ids=[<span class="str">"document_7"</span>],
    documents=[<span class="str">"... [Policy: POL-001]. [Claim: CLM-2024-012]. ..."</span>],
    metadatas=[{<span class="str">"type"</span>: <span class="str">"document"</span>, <span class="str">"policy_number"</span>: <span class="str">"POL-001"</span>, <span class="str">"claim_number"</span>: <span class="str">"CLM-2024-012"</span>}]
)
    </div>

    <div class="highlight" style="margin-top:16px">
      <strong>Chat upload vs. Claim evidence upload:</strong><br>
      Chat upload: Document stored but NOT linked to any policy/claim (general context)<br>
      Claim evidence: Document linked to specific policy + claim (targeted retrieval)
    </div>
  </div>
</div>

<!-- ════════════════ PHASE 8: LIVE EXAMPLE ════════════════ -->
<div class="section">
  <h2><span class="section-num">8</span> Live Example: Upload 5 Documents for a Policy</h2>

  <div class="card">
    <h3>Scenario: Policyholder "Acme Manufacturing" (POL-001)</h3>
    <p>User uploads 5 documents to assess this policy's risk. Here's what happens:</p>

    <table class="comp-table">
      <tr>
        <th>#</th>
        <th>Document</th>
        <th>Bedrock Analysis</th>
        <th>ChromaDB Entry</th>
      </tr>
      <tr>
        <td><span class="badge badge-coral">1</span></td>
        <td>property-inspection.pdf</td>
        <td>"North wall structural weakness, 3 roof leak areas"</td>
        <td>document_101 in knowledge</td>
      </tr>
      <tr>
        <td><span class="badge badge-blue">2</span></td>
        <td>fire-certificate.pdf</td>
        <td>"Fire suppression system last inspected 2023, 2 sprinklers non-functional"</td>
        <td>document_102 in knowledge</td>
      </tr>
      <tr>
        <td><span class="badge badge-green">3</span></td>
        <td>financial-statement.pdf</td>
        <td>"Revenue $12M, operating margin 8%, debt-to-equity 2.3"</td>
        <td>document_103 in knowledge</td>
      </tr>
      <tr>
        <td><span class="badge badge-amber">4</span></td>
        <td>site-photo.jpg</td>
        <td>"Industrial facility, visible rust on exterior, loading dock damage"</td>
        <td>document_104 in knowledge</td>
      </tr>
      <tr>
        <td><span class="badge badge-purple">5</span></td>
        <td>loss-run-report.pdf</td>
        <td>"3 claims in past 2 years: $45K water, $89K fire, $12K liability"</td>
        <td>document_105 in knowledge</td>
      </tr>
    </table>

    <h3 style="margin-top:24px">Now the user asks: "Should we renew Acme Manufacturing?"</h3>
    <p>The LLM receives ALL of this context:</p>

    <div class="code">
<span class="cm"># What the LLM sees in its prompt:</span>

<span class="str">STRUCTURED DATA: POL-001, Acme Manufacturing, Premium: $85,000, 3 claims, Loss Ratio: 171%

SESSION DOCUMENTS (5 uploaded):
1. property-inspection.pdf: North wall weakness, 3 roof leaks
2. fire-certificate.pdf: 2 non-functional sprinklers
3. financial-statement.pdf: Revenue $12M, margin 8%
4. site-photo.jpg: Visible rust, loading dock damage
5. loss-run-report.pdf: 3 claims totaling $146,000

GUIDELINES (from ChromaDB):
- 5.1.3: Loss ratio > 65% warrants 15-25% surcharge
- 3.1.1: 5+ claims = HIGH risk classification

KNOWLEDGE (from ChromaDB):
- Claim CLM-2024-012: Water damage $45,000
- Decision: No prior decision on POL-001</span>
    </div>

    <div class="highlight" style="margin-top:16px; border-left-color: var(--green);">
      <strong>LLM Response:</strong> "Based on comprehensive analysis of 5 uploaded documents and historical claims data, I recommend <strong>REFER</strong> for senior review. The 171% loss ratio (Guideline 5.1.3) and structural issues from the inspection report present significant risk. However, the $12M revenue and operating margin suggest the policyholder can sustain a premium increase of 25-30% ($106K-$110K) to achieve an acceptable risk profile. Key conditions: require fire suppression repair within 90 days, and schedule follow-up structural assessment."
    </div>
  </div>
</div>

<!-- ════════════════ SUMMARY ════════════════ -->
<div class="section">
  <h2><span class="section-num">9</span> Summary: The Four Layers of Context</h2>

  <div class="card">
    <table class="comp-table">
      <tr>
        <th>Layer</th>
        <th>Source</th>
        <th>How Retrieved</th>
        <th>What It Contains</th>
      </tr>
      <tr>
        <td><span class="badge badge-coral">1. Structured Data</span></td>
        <td>SQLite</td>
        <td>SQL queries (cached 60s)</td>
        <td>Policies, claims, premiums, loss ratios — all numerical data</td>
      </tr>
      <tr>
        <td><span class="badge badge-blue">2. Guidelines</span></td>
        <td>ChromaDB <code>guidelines</code></td>
        <td>Vector similarity search (k=5)</td>
        <td>Underwriting rules, thresholds, procedures</td>
      </tr>
      <tr>
        <td><span class="badge badge-green">3. Knowledge</span></td>
        <td>ChromaDB <code>knowledge</code></td>
        <td>Vector similarity search (k=4)</td>
        <td>Claim narratives, past decisions, uploaded document analyses</td>
      </tr>
      <tr>
        <td><span class="badge badge-purple">4. Session Docs</span></td>
        <td>SQLite <code>documents</code></td>
        <td>Direct SQL lookup by session_id</td>
        <td>Files uploaded in the current conversation</td>
      </tr>
    </table>

    <div class="pipeline" style="margin-top:24px">
      <div class="pipe-node n-coral">Structured Data</div>
      <span class="pipe-arrow">+</span>
      <div class="pipe-node n-blue">Guidelines RAG</div>
      <span class="pipe-arrow">+</span>
      <div class="pipe-node n-green">Knowledge RAG</div>
      <span class="pipe-arrow">+</span>
      <div class="pipe-node n-purple">Session Docs</div>
      <span class="pipe-arrow">=</span>
      <div class="pipe-node n-amber">Complete Context</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-cyan">LLM</div>
      <span class="pipe-arrow">&rarr;</span>
      <div class="pipe-node n-pink">Grounded Answer</div>
    </div>
  </div>
</div>

</div> <!-- /container -->

<div class="footer">
  RiskMind RAG Pipeline Documentation &mdash; Built for the AI Underwriting Co-Pilot Demo
</div>

<script>
function toggleStep(el) {
  // Close all siblings
  const siblings = el.parentElement.querySelectorAll('.step');
  siblings.forEach(s => {
    if (s !== el) s.classList.remove('active');
  });
  el.classList.toggle('active');
}

function switchTab(event, tabId) {
  const container = event.target.closest('.card');
  container.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  container.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById(tabId).classList.add('active');
}

function toggleExpand(btn) {
  const target = btn.nextElementSibling;
  target.classList.toggle('open');
  btn.textContent = target.classList.contains('open') ? 'Show Less' : 'Show More';
}
</script>
</body>
</html>
